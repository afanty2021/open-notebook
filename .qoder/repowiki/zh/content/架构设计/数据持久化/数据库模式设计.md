# 数据库模式设计

<cite>
**本文档引用的文件**  
- [1.surrealql](file://migrations/1.surrealql)
- [2.surrealql](file://migrations/2.surrealql)
- [3.surrealql](file://migrations/3.surrealql)
- [4.surrealql](file://migrations/4.surrealql)
- [5.surrealql](file://migrations/5.surrealql)
- [6.surrealql](file://migrations/6.surrealql)
- [7.surrealql](file://migrations/7.surrealql)
- [8.surrealql](file://migrations/8.surrealql)
- [9.surrealql](file://migrations/9.surrealql)
- [notebook.py](file://open_notebook/domain/notebook.py)
- [podcast.py](file://open_notebook/domain/podcast.py)
- [models.py](file://open_notebook/domain/models.py)
</cite>

## 目录
1. [引言](#引言)
2. [模式演进历史](#模式演进历史)
3. [核心实体关系图](#核心实体关系图)
4. [核心表结构说明](#核心表结构说明)
5. [字段命名规范与设计模式](#字段命名规范与设计模式)
6. [索引与搜索策略](#索引与搜索策略)
7. [记录链接与关系建模](#记录链接与关系建模)
8. [函数与业务逻辑](#函数与业务逻辑)
9. [总结](#总结)

## 引言

open-notebook项目采用SurrealDB作为其核心数据库，利用其图+文档混合模型来支持复杂的数据关联查询。本设计文档详细解析了在SurrealDB中的表结构设计与演进过程，基于`migrations`目录下的SurrealQL脚本，系统性地介绍了每个版本的模式变更。文档涵盖了`notebook`、`source`、`note`、`model`、`podcast`等核心实体的创建、字段定义、数据类型选择、主外键关系、索引策略以及record links的使用。通过图+文档混合模型，系统能够高效地支持笔记本与内容源、笔记、模型之间的复杂关系建模。

**Section sources**
- [1.surrealql](file://migrations/1.surrealql#L1-L179)

## 模式演进历史

open-notebook的数据库模式通过一系列SurrealQL迁移脚本进行演进，从初始版本到当前版本共经历了9次主要变更。每次迁移都通过`DEFINE TABLE`、`DEFINE FIELD`等语句精确地定义了表结构和字段约束，确保了数据的完整性和一致性。

### 版本1：基础结构搭建
第一个迁移脚本（`1.surrealql`）建立了最核心的表结构：
- `source`：存储内容源，如文章、视频等。
- `note`：存储用户创建的笔记。
- `notebook`：存储笔记本，用于组织内容源和笔记。
- `source_embedding` 和 `source_insight`：用于存储内容源的向量化嵌入和AI生成的洞察。
- `reference` 和 `artifact`：作为关系表，分别连接`source`到`notebook`和`note`到`notebook`。

此版本还定义了全文搜索分析器`my_analyzer`和多个全文索引，为后续的文本搜索功能奠定了基础。

### 版本2：笔记类型扩展
第二个迁移脚本（`2.surrealql`）为`note`表增加了一个`note_type`字段，用于区分笔记是由用户（human）还是AI（ai）生成的，增强了笔记的元数据信息。

### 版本3：聊天会话与向量搜索优化
第三个迁移脚本（`3.surrealql`）引入了`chat_session`表，用于存储用户的聊天会话。同时，它重构了`fn::vector_search`和`fn::text_search`函数，增加了`min_similarity`参数以过滤低相关性的向量搜索结果，并优化了返回结果的结构，使其包含更丰富的上下文信息。

### 版本4：搜索函数再优化
第四个迁移脚本（`4.surrealql`）再次优化了`fn::text_search`和`fn::vector_search`函数。它修正了`source_embedding_search`查询中`id`的来源，确保返回的是`source`的ID而非`source_embedding`的ID，使搜索结果的上下文更加一致。同时，`vector_search`函数的返回结果增加了`matches`字段，用于聚合匹配的文本内容。

### 版本5：转换功能引入
第五个迁移脚本（`5.surrealql`）引入了`transformation`表，用于存储预设的AI转换模板（如“论文分析”、“关键洞察”等）。该脚本还通过`INSERT`语句初始化了多个默认转换模板，并通过`UPSERT`语句设置了默认的转换指令。

### 版本6：模型提供者修正
第六个迁移脚本（`6.surrealql`）是一个简单的数据修正脚本，将`model`表中所有`provider`为`vertexai`的记录更新为`vertex`，确保了数据的一致性。

### 版本7：播客功能增强
第七个迁移脚本（`7.surrealql`）为播客功能引入了新的表结构：
- `episode_profile`：定义播客节目的配置模板。
- `speaker_profile`：定义播客中说话人的声音和个性配置。
- `episode`：存储具体的播客剧集。

此版本还为这些新表创建了唯一索引，以保证数据的完整性。

### 版本8：聊天会话关系扩展
第八个迁移脚本（`8.surrealql`）对`refers_to`关系表进行了重大修改，使其可以从`chat_session`指向`notebook`或`source`，从而支持用户在笔记本或单个内容源上开启聊天会话。同时，它为`chat_session`表增加了`model_override`字段，允许用户为单个会话选择特定的AI模型。

### 版本9：向量搜索健壮性增强
第九个迁移脚本（`9.surrealql`）最后一次优化了`fn::vector_search`函数。它增加了对`embedding`字段的空值和长度检查（`embedding != none and array::len(embedding)=array::len($query)`），防止了因向量维度不匹配或空嵌入导致的搜索错误，极大地提高了向量搜索的健壮性。

**Section sources**
- [1.surrealql](file://migrations/1.surrealql#L1-L179)
- [2.surrealql](file://migrations/2.surrealql#L1-L2)
- [3.surrealql](file://migrations/3.surrealql#L1-L146)
- [4.surrealql](file://migrations/4.surrealql#L1-L134)
- [5.surrealql](file://migrations/5.surrealql#L1-L170)
- [6.surrealql](file://migrations/6.surrealql#L1-L1)
- [7.surrealql](file://migrations/7.surrealql#L1-L153)
- [8.surrealql](file://migrations/8.surrealql#L1-L12)
- [9.surrealql](file://migrations/9.surrealql#L1-L66)

## 核心实体关系图

```mermaid
erDiagram
source {
string id PK
object asset
string title
array<string> topics
string full_text
datetime created
datetime updated
record<command> command
}
note {
string id PK
string title
string summary
string content
array<float> embedding
string note_type
datetime created
datetime updated
}
notebook {
string id PK
string name
string description
bool archived
datetime created
datetime updated
}
model {
string id PK
string name
string provider
string type
}
episode_profile {
string id PK
string name UK
string description
string speaker_config
string outline_provider
string outline_model
string transcript_provider
string transcript_model
string default_briefing
int num_segments
datetime created
datetime updated
}
speaker_profile {
string id PK
string name UK
string description
string tts_provider
string tts_model
array<object> speakers
datetime created
datetime updated
}
episode {
string id PK
string name
object episode_profile
object speaker_profile
string briefing
string content
string audio_file
object transcript
object outline
record<command> command
datetime created
datetime updated
}
source_embedding {
string id PK
record<source> source FK
int order
string content
array<float> embedding
}
source_insight {
string id PK
record<source> source FK
string insight_type
string content
array<float> embedding
}
transformation {
string id PK
string name
string title
string description
string prompt
bool apply_default
datetime created
datetime updated
}
chat_session {
string id PK
string title
string model_override
datetime created
datetime updated
}
reference {
record<source> in FK
record<notebook> out FK
}
artifact {
record<note> in FK
record<notebook> out FK
}
refers_to {
record<chat_session> in FK
record<notebook|source> out FK
}
source ||--o{ source_embedding : "has"
source ||--o{ source_insight : "has"
source }o--|| reference : "in"
note }o--|| artifact : "in"
notebook ||--o{ reference : "out"
notebook ||--o{ artifact : "out"
notebook ||--o{ chat_session : "referred by"
source ||--o{ chat_session : "referred by"
chat_session }o--|| refers_to : "in"
episode_profile ||--o{ episode : "used by"
speaker_profile ||--o{ episode : "used by"
```

**Diagram sources**
- [1.surrealql](file://migrations/1.surrealql#L2-L57)
- [7.surrealql](file://migrations/7.surrealql#L1-L38)
- [8.surrealql](file://migrations/8.surrealql#L5-L7)

## 核心表结构说明

以下表格详细说明了各核心表的字段定义、数据类型和用途。

### notebook 表
| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| id | string | 是 | - | 主键，记录ID |
| name | string | 是 | - | 笔记本名称 |
| description | string | 否 | - | 笔记本描述 |
| archived | bool | 否 | False | 是否已归档 |
| created | datetime | 是 | time::now() | 创建时间 |
| updated | datetime | 是 | time::now() | 更新时间 |

### source 表
| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| id | string | 是 | - | 主键，记录ID |
| asset | object | 否 | - | 资源信息（文件路径或URL） |
| title | string | 否 | - | 内容源标题 |
| topics | array<string> | 否 | - | 主题标签 |
| full_text | string | 否 | - | 完整文本内容 |
| command | record<command> | 否 | - | 关联的处理命令ID |
| created | datetime | 是 | time::now() | 创建时间 |
| updated | datetime | 是 | time::now() | 更新时间 |

### note 表
| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| id | string | 是 | - | 主键，记录ID |
| title | string | 否 | - | 笔记标题 |
| summary | string | 否 | - | 笔记摘要 |
| content | string | 否 | - | 笔记内容 |
| embedding | array<float> | 否 | - | 内容的向量嵌入 |
| note_type | string | 否 | - | 笔记类型（human/ai） |
| created | datetime | 是 | time::now() | 创建时间 |
| updated | datetime | 是 | time::now() | 更新时间 |

### model 表
| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| id | string | 是 | - | 主键，记录ID |
| name | string | 是 | - | 模型名称 |
| provider | string | 是 | - | 模型提供商 |
| type | string | 是 | - | 模型类型（language, embedding等） |

### transformation 表
| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| id | string | 是 | - | 主键，记录ID |
| name | string | 是 | - | 转换名称 |
| title | string | 是 | - | 转换标题 |
| description | string | 是 | - | 转换描述 |
| prompt | string | 是 | - | AI提示词模板 |
| apply_default | bool | 否 | False | 是否默认应用 |
| created | datetime | 是 | time::now() | 创建时间 |
| updated | datetime | 是 | time::now() | 更新时间 |

### episode_profile 表
| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| id | string | 是 | - | 主键，记录ID |
| name | string | 是 | - | 配置名称 |
| description | string | 否 | - | 配置描述 |
| speaker_config | string | 是 | - | 说话人配置名称 |
| outline_provider | string | 是 | - | 大纲生成AI提供商 |
| outline_model | string | 是 | - | 大纲生成AI模型 |
| transcript_provider | string | 是 | - | 转录生成AI提供商 |
| transcript_model | string | 是 | - | 转录生成AI模型 |
| default_briefing | string | 是 | - | 默认简报模板 |
| num_segments | int | 否 | 5 | 分段数量 |
| created | datetime | 是 | time::now() | 创建时间 |
| updated | datetime | 是 | time::now() | 更新时间 |

### speaker_profile 表
| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| id | string | 是 | - | 主键，记录ID |
| name | string | 是 | - | 配置名称 |
| description | string | 否 | - | 配置描述 |
| tts_provider | string | 是 | - | TTS提供商 |
| tts_model | string | 是 | - | TTS模型 |
| speakers | array<object> | 是 | - | 说话人数组 |
| created | datetime | 是 | time::now() | 创建时间 |
| updated | datetime | 是 | time::now() | 更新时间 |

### episode 表
| 字段名 | 数据类型 | 是否必填 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| id | string | 是 | - | 主键，记录ID |
| name | string | 是 | - | 剧集名称 |
| episode_profile | object | 是 | - | 使用的剧集配置 |
| speaker_profile | object | 是 | - | 使用的说话人配置 |
| briefing | string | 是 | - | 简报内容 |
| content | string | 是 | - | 源内容 |
| audio_file | string | 否 | - | 音频文件路径 |
| transcript | object | 否 | - | 生成的转录 |
| outline | object | 否 | - | 生成的大纲 |
| command | record<command> | 否 | - | 关联的处理命令ID |
| created | datetime | 是 | time::now() | 创建时间 |
| updated | datetime | 是 | time::now() | 更新时间 |

**Section sources**
- [1.surrealql](file://migrations/1.surrealql#L2-L53)
- [2.surrealql](file://migrations/2.surrealql#L1-L2)
- [5.surrealql](file://migrations/5.surrealql#L8-L17)
- [7.surrealql](file://migrations/7.surrealql#L1-L38)

## 字段命名规范与设计模式

open-notebook的数据库模式遵循了一套清晰的命名规范和设计模式，以确保代码的可读性和可维护性。

### 字段命名规范
- **小写下划线命名法**：所有字段名均采用小写和下划线分隔的命名方式，如`full_text`、`created_at`，这符合SurrealDB的推荐实践。
- **语义化命名**：字段名具有明确的语义，如`archived`表示归档状态，`command`表示关联的命令ID，便于开发者理解。
- **类型后缀**：对于特定类型的字段，使用了描述性后缀，如`embedding`表示向量嵌入，`profile`表示配置模板。

### 时间戳处理
所有核心表都包含了`created`和`updated`两个时间戳字段，用于记录数据的生命周期。
- `created`字段使用`DEFAULT time::now() VALUE $before OR time::now()`，确保在记录创建时设置时间，并在后续更新中保持不变。
- `updated`字段使用`DEFAULT time::now() VALUE time::now()`，确保每次记录更新时都会自动刷新为当前时间。

### 软删除设计模式
虽然在提供的迁移脚本中没有直接体现，但从`notebook`表的`archived`字段可以推断出系统采用了软删除设计模式。当用户“删除”一个笔记本时，系统并非物理删除记录，而是将其`archived`字段设置为`True`。这允许用户在需要时恢复数据，同时避免了因级联删除而丢失关联内容（如笔记和内容源）的风险。

**Section sources**
- [1.surrealql](file://migrations/1.surrealql#L13-L14)
- [1.surrealql](file://migrations/1.surrealql#L41-L42)
- [1.surrealql](file://migrations/1.surrealql#L51-L52)
- [1.surrealql](file://migrations/1.surrealql#L48-L49)

## 索引与搜索策略

open-notebook充分利用了SurrealDB的索引功能，特别是全文搜索和向量搜索，以支持高效的内容检索。

### 全文搜索索引
系统定义了一个名为`my_analyzer`的自定义分析器，结合了`blank`、`class`、`camel`、`punct`分词器和`snowball(english)`、`lowercase`过滤器，能够有效处理英文文本的分词和标准化。基于此分析器，为多个文本字段创建了全文索引：
- `idx_source_title`：在`source`表的`title`字段上。
- `idx_source_full_text`：在`source`表的`full_text`字段上。
- `idx_note`：在`note`表的`content`字段上。
- `idx_note_title`：在`note`表的`title`字段上。

这些索引使得`fn::text_search`函数能够快速执行全文搜索，并返回带有高亮的匹配结果。

### 向量搜索
系统通过`source_embedding`和`source_insight`表存储内容的向量嵌入。`fn::vector_search`函数利用`vector::similarity::cosine`函数计算余弦相似度，实现基于语义的向量搜索。为了提高搜索的准确性和健壮性，该函数增加了`min_similarity`参数来过滤低相关性的结果，并在最终版本中加入了对向量维度和空值的检查。

**Section sources**
- [1.surrealql](file://migrations/1.surrealql#L65-L72)
- [1.surrealql](file://migrations/1.surrealql#L74-L136)
- [3.surrealql](file://migrations/3.surrealql#L10-L73)
- [4.surrealql](file://migrations/4.surrealql#L75-L134)
- [9.surrealql](file://migrations/9.surrealql#L4-L66)

## 记录链接与关系建模

SurrealDB的`record`类型和`RELATION`表是实现图+文档混合模型的关键。open-notebook巧妙地利用这些特性来建模复杂的数据关系。

### Record Links
`record`类型用于表示对其他表中记录的引用。例如：
- `source_embedding`表中的`source`字段是`record<source>`类型，直接指向`source`表中的具体记录。
- `refers_to`关系表的`out`字段被定义为`record<notebook|source>`，使其能够灵活地指向`notebook`或`source`表，实现了多态关系。

### 关系表（RELATION）
系统使用`TYPE RELATION`定义了三种核心关系表：
- `reference`：表示`source`与`notebook`之间的多对多关系。一个内容源可以被多个笔记本引用，一个笔记本可以包含多个内容源。
- `artifact`：表示`note`与`notebook`之间的多对多关系。一个笔记可以被添加到多个笔记本，一个笔记本可以包含多个笔记。
- `refers_to`：表示`chat_session`与`notebook`或`source`之间的多对多关系。一个聊天会话可以关联到一个笔记本或一个内容源。

这些关系表不仅定义了数据的关联方式，还通过`DEFINE EVENT`（如`source_delete`事件）实现了级联删除等业务逻辑，确保了数据的一致性。

**Section sources**
- [1.surrealql](file://migrations/1.surrealql#L54-L60)
- [8.surrealql](file://migrations/8.surrealql#L5-L7)
- [1.surrealql](file://migrations/1.surrealql#L29-L32)

## 函数与业务逻辑

数据库模式中定义的函数封装了核心的业务逻辑，将复杂的查询操作抽象为可复用的接口。

### fn::text_search
该函数是全文搜索的核心。它接收一个查询文本、结果数量和布尔标志，然后并行地在`source`的标题、全文、嵌入块和洞察，以及`note`的标题和内容中进行搜索。它使用`@1@`操作符执行全文搜索，并通过`search::score(1)`获取相关性分数。最终，函数将所有结果合并、去重，并按相关性排序返回。

### fn::vector_search
该函数是语义搜索的核心。它接收一个查询向量（由AI模型生成）、结果数量、布尔标志和最小相似度阈值。它在`source_embedding`、`source_insight`和`note`表中计算查询向量与存储向量的余弦相似度，过滤掉低于阈值的结果，然后合并、分组并按相似度排序返回。该函数的多次迭代优化体现了对搜索质量和系统健壮性的持续追求。

**Section sources**
- [1.surrealql](file://migrations/1.surrealql#L74-L173)
- [3.surrealql](file://migrations/3.surrealql#L10-L73)
- [4.surrealql](file://migrations/4.surrealql#L75-L134)
- [9.surrealql](file://migrations/9.surrealql#L4-L66)

## 总结

open-notebook在SurrealDB中的数据库模式设计充分体现了图+文档混合模型的优势。通过精心设计的表结构、灵活的记录链接、强大的索引策略和封装良好的数据库函数，系统能够高效地支持复杂的数据关联查询和AI驱动的功能。模式的演进历史展示了从基础功能到高级特性的逐步完善过程，每一次迁移都精准地解决了特定的业务需求和技术挑战。这套设计为构建一个功能丰富、性能优越的知识管理应用奠定了坚实的基础。