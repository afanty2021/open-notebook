# 故障排除

<cite>
**本文档引用的文件**   
- [common-issues.md](file://docs/troubleshooting/common-issues.md)
- [debugging.md](file://docs/troubleshooting/debugging.md)
- [quick-fixes.md](file://docs/troubleshooting/quick-fixes.md)
- [faq.md](file://docs/troubleshooting/faq.md)
- [CLAUDE.md](file://CLAUDE.md)
- [MAINTAINER_GUIDE.md](file://MAINTAINER_GUIDE.md)
- [main.py](file://api/main.py)
- [search.py](file://api/routers/search.py)
- [chat.py](file://api/routers/chat.py)
- [models.py](file://api/routers/models.py)
- [repository.py](file://open_notebook/database/repository.py)
- [client.ts](file://frontend/src/lib/api/client.ts)
- [use-ask.ts](file://frontend/src/lib/hooks/use-ask.ts)
</cite>

## 目录
1. [常见问题](#常见问题)
2. [调试与诊断](#调试与诊断)
3. [快速修复指南](#快速修复指南)
4. [常见问题解答](#常见问题解答)
5. [提示工程调试技巧](#提示工程调试技巧)
6. [维护建议](#维护建议)
7. [日志分析](#日志分析)
8. [性能问题排查](#性能问题排查)
9. [数据库问题排查](#数据库问题排查)
10. [AI模型问题排查](#ai模型问题排查)
11. [网络连接问题排查](#网络连接问题排查)
12. [附录](#附录)

## 常见问题

本节系统性地列出用户在使用过程中遇到的常见问题，包括现象、可能原因及解决方案。

### API连接失败

**现象**：前端显示"无法连接到服务器"或"连接错误"。

**可能原因**：
- API_URL配置不正确
- 端口5055未暴露
- 使用了localhost作为API_URL但远程访问
- API_URL末尾添加了/api路径

**解决方案**：
1. 确保在docker-compose.yml中暴露了端口5055：
```yaml
ports:
  - "8502:8502"
  - "5055:5055"
```

2. 根据访问方式设置正确的API_URL：
   - 本地访问：无需设置或使用`http://localhost:5055`
   - 远程访问：使用服务器IP地址，如`http://192.168.1.100:5055`
   - 反向代理：使用`https://yourdomain.com/api`

3. 确保API_URL不包含末尾的/api路径，该路径由应用自动添加。

4. 修改配置后重启容器：
```bash
docker compose down && docker compose up -d
```

**Section sources**
- [common-issues.md](file://docs/troubleshooting/common-issues.md#-unable-to-connect-to-server-or-connection-error)
- [quick-fixes.md](file://docs/troubleshooting/quick-fixes.md#fix-connection-error)

### AI模型响应超时

**现象**：前端显示"timeout of 30000ms exceeded"或"Failed to connect to API: timed out"。

**可能原因**：
- 前端客户端超时时间过短
- AI模型处理速度慢
- 硬件性能不足
- 网络延迟高

**解决方案**：
1. 增加API客户端超时时间，在.env文件中添加：
```bash
API_CLIENT_TIMEOUT=600  # 10分钟
```

2. 根据不同场景调整超时时间：
   - 云AI服务（OpenAI, Anthropic）：300秒（5分钟）
   - 本地Ollama（GPU）：600秒（10分钟）
   - 本地Ollama（CPU）：1200秒（20分钟）
   - 远程LM Studio：900秒（15分钟）

3. 增加LLM提供者超时时间（仅在模型推理超时时）：
```bash
ESPERANTO_LLM_TIMEOUT=180  # 3分钟
```

4. 重启服务使配置生效：
```bash
docker compose down && docker compose up -d
```

**重要提示**：API_CLIENT_TIMEOUT应大于ESPERANTO_LLM_TIMEOUT以确保正确的错误处理。

**Section sources**
- [common-issues.md](file://docs/troubleshooting/common-issues.md#api-timeout-errors-during-transformations)
- [faq.md](file://docs/troubleshooting/faq.md#why-do-i-get-timeout-errors-even-though-transformations-complete-successfully)

### 搜索功能异常

**现象**：搜索无结果、搜索结果不相关或搜索功能完全不可用。

**可能原因**：
- 未配置嵌入模型
- 数据库查询错误
- 向量搜索索引问题
- 文本搜索配置错误

**解决方案**：
1. 确保已配置嵌入模型：
   - 进入"模型"设置页面
   - 配置支持的嵌入模型（如text-embedding-3-small）
   - 设置为默认嵌入模型

2. 检查搜索请求类型：
   - 向量搜索需要嵌入模型支持
   - 文本搜索可独立工作

3. 验证搜索API端点：
```bash
curl -X POST http://localhost:5055/api/search \
  -H "Content-Type: application/json" \
  -d '{"query": "test", "type": "text", "limit": 10}'
```

4. 检查后端日志中的搜索错误：
```bash
docker compose logs open_notebook | grep "search"
```

**Section sources**
- [search.py](file://api/routers/search.py#L17-L59)
- [common-issues.md](file://docs/troubleshooting/common-issues.md#slow-search-and-chat)

## 调试与诊断

本节提供全面的调试技术、日志分析方法和性能分析工具。

### 日志级别

Open Notebook使用结构化日志记录，包含以下级别：
- `DEBUG`：详细的调试信息
- `INFO`：系统操作的一般信息
- `WARNING`：潜在的问题情况
- `ERROR`：可能允许应用程序继续的错误事件
- `CRITICAL`：可能导致应用程序中止的严重错误

### 访问日志

#### Docker部署
```bash
# 查看所有服务日志
docker compose logs

# 实时跟踪日志
docker compose logs -f

# 查看特定服务日志
docker compose logs surrealdb
docker compose logs open_notebook

# 查看最后100行
docker compose logs --tail=100

# 查看带时间戳的日志
docker compose logs -t
```

#### 源码安装
```bash
# API日志
tail -f api.log

# 工作进程日志
tail -f worker.log

# 数据库日志
docker compose logs surrealdb

# Next.js日志
# 在前台运行以直接查看日志
```

### 日志配置

#### 启用调试日志
```bash
# 添加到.env或docker.env
LOG_LEVEL=DEBUG

# 重启服务
docker compose restart
```

#### 自定义日志配置
```python
import logging
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
```

**Section sources**
- [debugging.md](file://docs/troubleshooting/debugging.md#理解日志级别)
- [debugging.md](file://docs/troubleshooting/debugging.md#访问日志)

## 快速修复指南

本节提供快速解决问题的步骤，适用于紧急情况。

### "无法连接到服务器"的修复

1. **检查API是否运行**：
```bash
curl http://localhost:5055/health
# 应返回：{"status": "healthy"}
```

2. **检查端口暴露**：
```bash
docker ps
# 查看是否有：0.0.0.0:5055->5055
```

3. **设置正确的API_URL**：
```yaml
environment:
  - API_URL=http://YOUR_SERVER_IP:5055
```

4. **重启容器**：
```bash
docker compose down && docker compose up -d
```

### 容器无法启动的修复

1. **检查日志**：
```bash
docker logs open-notebook
# 或
docker compose logs
```

2. **常见问题及解决方案**：
| 错误信息 | 解决方案 |
|---------|---------|
| "Port already in use" | 更改端口或停止冲突服务 |
| "Permission denied" | 将用户添加到docker组：`sudo usermod -aG docker $USER` |
| "Invalid API key" | 检查环境变量中的OPENAI_API_KEY |
| "Out of memory" | 在Docker Desktop设置中增加内存限制 |
| "No such file or directory" | 检查卷路径是否存在且可访问 |

3. **快速重置**：
```bash
docker compose down -v
docker compose up -d
```

**Section sources**
- [quick-fixes.md](file://docs/troubleshooting/quick-fixes.md#fix-connection-error)
- [quick-fixes.md](file://docs/troubleshooting/quick-fixes.md#fix-container-crash)

## 常见问题解答

本节回答用户关于使用、配置和最佳实践的常见问题。

### 什么是Open Notebook？

Open Notebook是一个开源、注重隐私的研究助手，作为Google Notebook LM的替代品。主要功能包括：
- 创建和管理研究笔记本
- 使用AI与文档对话
- 从内容生成播客
- 语义搜索所有来源
- 转换和分析内容

### 与Google Notebook LM的区别

**隐私**：默认情况下数据保留在本地，只有选择的AI提供商接收查询。
**灵活性**：支持15+个AI提供商（OpenAI、Anthropic、Google、本地模型等）。
**可定制性**：开源，可修改和扩展功能。
**控制**：您控制数据、模型和处理。

### 支持的文件类型

**文档**：
- PDF（文本提取）
- Microsoft Word（DOC, DOCX）
- 纯文本（TXT）
- Markdown（MD）

**网页内容**：
- URL（自动网页抓取）
- YouTube视频（转录提取）
- 网页文章和博客

**媒体**：
- 图像（PNG, JPG, GIF, WebP）带OCR
- 音频文件（MP3, WAV, M4A）带转录
- 视频文件（MP4, AVI, MOV）用于转录提取

**其他**：
- 直接文本输入
- CSV数据
- 代码文件（带语法高亮）

**Section sources**
- [faq.md](file://docs/troubleshooting/faq.md#什么是open-notebook)
- [faq.md](file://docs/troubleshooting/faq.md#与google-notebook-lm的区别)
- [faq.md](file://docs/troubleshooting/faq.md#支持的文件类型)

## 提示工程调试技巧

本节整合CLAUDE.md中的提示工程调试技巧。

### 模型配置

1. **默认模型设置**：在设置页面配置各个任务的默认模型
2. **提供商支持**：支持OpenAI、Anthropic、Ollama、LM Studio等
3. **本地模型**：通过Ollama或LM Studio使用本地模型

### 上下文管理

- **三级控制**：精确、平衡、最大
- **隐私保护**：可选择不分享敏感内容
- **性能优化**：智能上下文截断

### 提示模板

- 模板位于`prompts/`目录
- 使用Jinja2模板引擎
- 支持动态变量注入

**Section sources**
- [CLAUDE.md](file://CLAUDE.md#ai-使用指引)
- [prompts/](file://prompts/)

## 维护建议

本节整合MAINTAINER_GUIDE.md中的维护建议。

### 问题管理

#### 新问题创建时的处理流程

1. **初始分类**（24-48小时内）
   - 添加适当的标签：
     - `bug`, `enhancement`, `documentation`等
     - `good first issue`用于初学者友好的任务
     - `needs-triage`直到被审查
     - `help wanted`表示欢迎社区贡献

2. **初步响应**
```markdown
感谢您提出此问题！我们会审查并尽快回复您。

[如果是bug] 同时，您是否检查过我们的[故障排除指南](docs/troubleshooting/index.md)？

[如果是功能] 您可能会发现我们的[设计原则](DESIGN_PRINCIPLES.md)有助于理解我们的构建方向。
```

### 拉取请求审查

#### 初始PR审查清单

**审查代码前**：
- [ ] 是否有关联的已批准问题？
- [ ] PR是否引用了问题编号？
- [ ] PR描述是否清楚地说明了更改内容和原因？
- [ ] 贡献者是否检查了PR模板中的相关框？
- [ ] 是否有测试？（UI更改的截图）？

**危险信号**（可能需要关闭PR）：
- 没有关联的问题
- 问题未分配给贡献者
- PR试图解决多个无关问题
- 未经讨论的破坏性更改
- 与项目愿景冲突

**Section sources**
- [MAINTAINER_GUIDE.md](file://MAINTAINER_GUIDE.md#issue-management)
- [MAINTAINER_GUIDE.md](file://MAINTAINER_GUIDE.md#pull-request-review)

## 日志分析

本节提供详细的日志分析方法和常见日志消息解读。

### 常见日志消息

#### 成功操作
```
INFO - Starting Open Notebook services
INFO - Database connection established
INFO - API server started on port 5055
INFO - React frontend started on port 8502
INFO - Background worker started
INFO - Model configuration loaded
INFO - Source processed successfully
```

#### 警告消息
```
WARNING - Rate limit approaching for provider: openai
WARNING - Large file upload detected: 50MB
WARNING - Model response truncated due to length
WARNING - Database connection retrying
WARNING - Cache miss for embedding
```

#### 错误消息
```
ERROR - Failed to connect to database: Connection refused
ERROR - API key invalid for provider: openai
ERROR - Model not found: gpt-4-invalid
ERROR - File processing failed: Unsupported format
ERROR - Background job failed: Timeout
ERROR - Memory limit exceeded
```

### 数据库连接错误诊断

#### 症状
```
ERROR - Database connection failed
ERROR - Connection refused at localhost:8000
ERROR - Authentication failed for SurrealDB
```

#### 诊断步骤
1. **检查SurrealDB状态**：
```bash
docker compose ps surrealdb
```

2. **验证连接设置**：
```bash
echo $SURREAL_URL
echo $SURREAL_USER
echo $SURREAL_PASSWORD
```

3. **测试直接连接**：
```bash
curl http://localhost:8000/health
```

4. **检查数据库日志**：
```bash
docker compose logs surrealdb
```

**Section sources**
- [debugging.md](file://docs/troubleshooting/debugging.md#常见日志消息)
- [debugging.md](file://docs/troubleshooting/debugging.md#数据库连接错误)

## 性能问题排查

本节提供性能问题的排查方法和优化建议。

### 系统资源监控

#### 实时监控
```bash
# Docker容器资源
docker stats

# 系统资源
htop

# 磁盘I/O
iostat -x 1

# 网络使用
nethogs
```

### 应用性能分析

#### 响应时间分析
```bash
# 测量API响应时间
time curl http://localhost:5055/api/notebooks

# 带详细输出的测量
curl -w "@curl-format.txt" http://localhost:5055/api/notebooks
```

创建`curl-format.txt`：
```
     time_namelookup:  %{time_namelookup}\n
        time_connect:  %{time_connect}\n
     time_appconnect:  %{time_appconnect}\n
    time_pretransfer:  %{time_pretransfer}\n
       time_redirect:  %{time_redirect}\n
  time_starttransfer:  %{time_starttransfer}\n
                     ----------\n
          time_total:  %{time_total}\n
```

### AI提供商性能

#### 响应时间监控
```bash
# 监控AI提供商响应时间
grep -r "provider.*response_time" logs/

# 检查超时
grep -r "timeout\|Timeout" logs/
```

**Section sources**
- [debugging.md](file://docs/troubleshooting/debugging.md#系统资源监控)
- [debugging.md](file://docs/troubleshooting/debugging.md#应用性能)

## 数据库问题排查

本节提供数据库相关问题的排查方法。

### 数据库调试

#### 直接数据库访问
```bash
# 直接连接到SurrealDB
docker compose exec surrealdb /surreal sql \
  --conn http://localhost:8000 \
  --user root \
  --pass root \
  --ns open_notebook \
  --db production
```

#### 查询分析
```sql
-- 检查表内容
SELECT * FROM notebook LIMIT 10;

-- 检查关系
SELECT * FROM source WHERE notebook_id = notebook:abc123;

-- 性能分析
SELECT count() FROM source GROUP BY notebook_id;
```

### 数据库连接问题

#### 常见问题
- 连接被拒绝
- 认证失败
- 端口未暴露
- 文件权限问题

#### 解决方案
1. **检查SurrealDB是否运行**：
```bash
docker compose ps surrealdb
```

2. **验证连接设置**：
```bash
echo $SURREAL_URL
echo $SURREAL_USER
```

3. **测试连接**：
```bash
curl http://localhost:8000/health
```

4. **重启SurrealDB**：
```bash
docker compose restart surrealdb
sleep 10
```

5. **检查文件权限**：
```bash
ls -la surreal_data/
sudo chown -R $USER:$USER surreal_data/
```

**Section sources**
- [debugging.md](file://docs/troubleshooting/debugging.md#数据库调试)
- [common-issues.md](file://docs/troubleshooting/common-issues.md#surrealdb-connection-issues)

## AI模型问题排查

本节提供AI模型相关问题的排查方法。

### AI提供商错误

#### API密钥问题
```
ERROR - Invalid API key for provider: openai
ERROR - Authentication failed: API key not found
ERROR - Insufficient credits for provider: anthropic
```

**诊断**：
```bash
# 测试OpenAI密钥
curl -H "Authorization: Bearer $OPENAI_API_KEY" \
     https://api.openai.com/v1/models

# 测试Anthropic密钥
curl -H "x-api-key: $ANTHROPIC_API_KEY" \
     https://api.anthropic.com/v1/models
```

#### 模型未找到
```
ERROR - Model not found: gpt-4-invalid
ERROR - Model not available for your account
```

**诊断**：
- 检查模型名称拼写
- 验证账户的模型可用性
- 检查提供商文档中的确切模型名称

#### 速率限制
```
ERROR - Rate limit exceeded for provider: openai
ERROR - Too many requests, please retry later
```

**诊断**：
```bash
# 检查提供商仪表板中的速率限制
# 监控请求频率
# 实现带退避的重试逻辑
```

### 模型配置问题

#### 常见问题
- 模型名称错误
- 提供商配置不正确
- API密钥无效
- 账户无模型访问权限

#### 解决方案
1. **检查模型名称**：
```bash
# 使用提供商文档中的确切模型名称
# OpenAI: gpt-5-mini, gpt-5, text-embedding-3-small
# Anthropic: claude-3-haiku-20240307, claude-3-sonnet-20240229
```

2. **验证提供商配置**：
   - 检查API密钥是否有效
   - 确保模型对您的账户可用
   - 先测试简单请求

3. **重置模型配置**：
   - 进入"模型"页面
   - 清除所有配置
   - 重新配置已知工作的模型

**Section sources**
- [debugging.md](file://docs/troubleshooting/debugging.md#ai-提供商错误)
- [models.py](file://api/routers/models.py#L217-L300)

## 网络连接问题排查

本节提供网络连接相关问题的排查方法。

### 服务通信

#### 内部Docker网络测试
```bash
# 测试内部Docker网络
docker compose exec open_notebook ping surrealdb

# 测试外部连接
docker compose exec open_notebook curl -I https://api.openai.com

# 检查端口绑定
netstat -tulpn | grep -E "(8000|5055|8502)"
```

### DNS解析

#### 容器内DNS检查
```bash
# 从容器检查DNS
docker compose exec open_notebook nslookup api.openai.com

# 检查/etc/hosts
docker compose exec open_notebook cat /etc/hosts
```

### 健康检查

#### 服务健康端点
```bash
# 检查所有健康端点
curl -f http://localhost:8000/health  # SurrealDB
curl -f http://localhost:5055/health  # API
curl -f http://localhost:8502/healthz  # Next.js
```

#### 自动化健康监控
```bash
#!/bin/bash
# health_check.sh

services=("8000" "5055" "8502")
for port in "${services[@]}"; do
    if curl -f http://localhost:$port/health* >/dev/null 2>&1; then
        echo "✅ 服务端口 $port 健康"
    else
        echo "❌ 服务端口 $port 不健康"
    fi
done
```

**Section sources**
- [debugging.md](file://docs/troubleshooting/debugging.md#网络调试)
- [debugging.md](file://docs/troubleshooting/debugging.md#健康检查)

## 附录

### 收集诊断信息

```bash
# 系统信息
uname -a
docker version
docker compose version
docker system info

# 服务状态
make status
docker compose ps

# 最近日志
docker compose logs --tail=100 > logs.txt
```

### 获取帮助

1. **收集诊断信息**：
   ```bash
   # 系统信息
   uname -a
   docker version
   docker compose version
   
   # 服务状态
   make status
   docker compose logs --tail=100 > logs.txt
   ```

2. **创建最小复现**：
   - 从干净环境开始
   - 记录确切步骤
   - 捕获证据（截图、日志、系统状态）

3. **寻求帮助**：
   - Discord: https://discord.gg/37XJPXfz2w
   - GitHub Issues: https://github.com/lfnovo/open-notebook/issues
   - 包含所有诊断信息（移除API密钥等敏感信息）

**Section sources**
- [common-issues.md](file://docs/troubleshooting/common-issues.md#getting-help)
- [debugging.md](file://docs/troubleshooting/debugging.md#支持信息收集)